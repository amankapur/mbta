$(document).on('ready', function(){
	var client_ip;
	var client_lat;
  var client_lon;
  $.getJSON("http://smart-ip.net/geoip-json?callback=?",
    function(data){
    	 client_ip = data.host;
       client_lat = data.latitude;
       client_lon = data.longitude;
  
 		var cloudmade = new CM.Tiles.CloudMade.Web({key: '7324c064b04d402eb2a58d68c935b63d'});
  	var map = new CM.Map('cm-example', cloudmade);
  	map.setCenter(new CM.LatLng(client_lat, client_lon), 15);
		map.addControl(new CM.LargeMapControl());
		
		
		function distance (lat1, lon1, lat2, lon2) {
			var rad = Math.PI / 180;
			var R = 6371; // km
			var dLat = (lat2-lat1) * rad ;
			var dLon = (lon2-lon1) * rad;
			var lat1 = lat1 * rad;
			var lat2 = lat2 * rad;

			var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2); 
			var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
			var d = R * c;
			return d
		}
		
		
		var map = {};
		<% Stop.all.each do |stop| %>
			var stop_loc = [];
			stop_loc.push(<%=stop.lat.to_f%>);
			stop_loc.push(<%=stop.lat.to_f%>);
			console.log(<%= stop.lat.to_f %>);
			map[<%=stop.id%>] = distance(client_lat, client_lon, stop_loc[0], stop_loc[1]);
		<% end %>
		console.log (map);
	
//		$.ajax({
//  		type: 'POST',
 // 		url: '/',
  //		data: {lat: client_lat, lon: client_lon},
 // 		success: function(data){
  //			console.log('Post successful');
 // 		},
 // 		error: function(xhr, ajaxOptions, thrownError){console.log(thrownError);},
	//		});


	});
		
  	
});

