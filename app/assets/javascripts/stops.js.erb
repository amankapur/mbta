$(document).on('ready', function(){
	var client_ip;
	var client_lat;
  var client_lon;
  $.getJSON("http://smart-ip.net/geoip-json?callback=?",
    function(data){
    	 client_ip = data.host;
       client_lat = data.latitude;
       client_lon = data.longitude;
  
 		var cloudmade = new CM.Tiles.CloudMade.Web({key: '7324c064b04d402eb2a58d68c935b63d'});
  	var map = new CM.Map('cm-example', cloudmade);
  	map.setCenter(new CM.LatLng(client_lat, client_lon), 15);
		map.addControl(new CM.LargeMapControl());
		
		
		function distance (lat1, lon1, lat2, lon2) {
			var rad = Math.PI / 180;
			var R = 6371; // km
			var dLat = (lat2-lat1) * rad ;
			var dLon = (lon2-lon1) * rad;
			var lat1 = lat1 * rad;
			var lat2 = lat2 * rad;

			var a = Math.sin(dLat/2) * Math.sin(dLat/2) + Math.sin(dLon/2) * Math.sin(dLon/2) * Math.cos(lat1) * Math.cos(lat2); 
			var c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1-a)); 
			var d = R * c;
			return d
		}
		function dynamicSort(property) {
   		 return function (a,b) {
        return (a[property] < b[property]) ? -1 : (a[property] > b[property]) ? 1 : 0;
    		}
		}
		
		var mapper = [];
		<% Stop.all.each do |stop| %>
			var stop_loc = [];
			stop_loc.push(<%=stop.lat.to_f%>);
			stop_loc.push(<%=stop.lat.to_f%>);
			temp ={}
			temp['stop_id'] = <%=stop.id%>
			temp['distance'] = distance(client_lat, client_lon, stop_loc[0], stop_loc[1]); 
			temp['lat'] = <%=stop.lat%>;
			temp['lon'] = <%=stop.lon%>;
			mapper.push(temp);
			temp = {}
		<% end %>
		mapper.sort(dynamicSort('distance'));
		
		var map_me = [];
		map_me.push(mapper[0]);
		map_me.push(mapper[1]);
		map_me.push(mapper[2]);
		
		console.log(map_me);
	
		for (var i = 0; i <= map_me.length-1; i++) {
			console.log(i);
			var myMarkerLatLng = new CM.LatLng(map_me[i].lat, map_me[i].lon);
			var myMarker = new CM.Marker(myMarkerLatLng, {
				title: "Bus Stop id : " + map_me[i].stop_id
			});
			map.addOverlay(myMarker);
		}
		
	});
		
  	
});

